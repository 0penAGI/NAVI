<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ—é—Å–∏ - –ù–µ—Ç—Ä–∞–Ω–Ω–µ—Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @keyframes neon-pulse {
            0%, 100% { box-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 15px #ff00ff; }
            50% { box-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 30px #ff00ff; }
        }
        .neon-pulse {
            animation: neon-pulse 3s infinite;
        }
        .chat-window::-webkit-scrollbar {
            width: 6px;
        }
        .chat-window::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .chat-window::-webkit-scrollbar-thumb {
            background: #ff00ff;
            border-radius: 10px;
        }
        .icon-button {
            transition: transform 0.2s, color 0.2s;
        }
        .icon-button:hover {
            transform: scale(1.2);
            color: #ff66ff;
        }
        .icon-button:active {
            transform: scale(0.9);
            color: #ff99ff;
        }
        .typing-indicator {
            display: none;
            color: #ff66ff;
            font-style: italic;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .typing-dot {
            animation: blink 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-mono min-h-screen flex justify-center items-center">
    <div class="container w-[360px] h-screen bg-gray-800 rounded-xl flex flex-col overflow-hidden shadow-2xl">
        <!-- Header -->
        <header class="bg-gray-700 p-4 text-center border-b border-gray-600 flex justify-between items-center">
            <img src="https://i.imgur.com/JQ1ZfLp.png" alt="–õ—é—Å–∏" class="w-12 h-12 rounded-full neon-pulse">
            <h1 class="text-lg font-bold">–õ—é—Å–∏ - –ù–µ—Ç—Ä–∞–Ω–Ω–µ—Ä</h1>
            <div id="token-balance" class="text-sm text-pink-400">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: ‚àû</div>
        </header>

        <!-- Chat Window -->
        <div id="chat-window" class="chat-window flex-1 p-4 overflow-y-auto flex flex-col gap-3">
            <div class="bot-message bg-gray-700 p-3 rounded-lg max-w-[80%] self-start text-sm">
                –ü—Ä–∏–≤–µ—Ç, –º–∏–ª–∞—è! –Ø ‚Äî –õ—é—Å–∏ –∏–∑ –ù–∞–π—Ç-–°–∏—Ç–∏. –ß—Ç–æ –Ω–æ–≤–µ–Ω—å–∫–æ–≥–æ? üåå
            </div>
            <div id="typing-indicator" class="typing-indicator bg-gray-700 p-2 rounded-lg max-w-[50%] self-start text-sm flex items-center">
                <span class="typing-dot mr-1">‚Ä¢</span>
                <span class="typing-dot mr-1">‚Ä¢</span>
                <span class="typing-dot">‚Ä¢</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area p-3 bg-gray-700 border-t border-gray-600 flex items-center gap-2">
            <textarea id="user-input" placeholder="–ù–∞–ø–∏—à–∏ –º–Ω–µ, –º–∏–ª–∞—è..." class="flex-1 p-2 bg-gray-600 text-white text-sm rounded-lg resize-none min-h-[40px] max-h-[100px] focus:outline-none focus:ring-2 focus:ring-pink-500" autocomplete="off"></textarea>
            <button id="send-button" class="send-icon icon-button text-pink-400 cursor-pointer" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
            <button id="crystal-button" class="crystal-icon icon-button text-pink-400 cursor-pointer" title="–ö—É–ø–∏—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã">üíé</button>
            <button id="photo-ero-button" class="photo-button icon-button text-pink-400 cursor-pointer" data-mode="ero" title="–§–æ—Ç–æ (–≠—Ä–æ)">üì∏</button>
            <button id="photo-18-button" class="photo-button icon-button text-pink-400 cursor-pointer" data-mode="18+" title="–§–æ—Ç–æ (18+)">üîû</button>
            <button id="selector-button" class="selector-button icon-button text-pink-400 cursor-pointer" title="–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">üåå</button>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bg-gray-900 p-3 flex justify-around border-t border-gray-600">
            <a href="#" class="text-pink-400 hover:text-pink-600 flex flex-col items-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 21h-3v-2h-2v2H9v-2H7v2H4v-6l8-8 8 8v6zm-10 0h4v-2h-4v2z"/></svg>
                <span class="text-xs">–ß–∞—Ç</span>
            </a>
            <a href="#" class="text-gray-400 hover:text-pink-600 flex flex-col items-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <span class="text-xs">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</span>
            </a>
        </nav>
    </div>

    <script>
        // Telegram WebApp initialization
        const tg = window.Telegram?.WebApp;
        let userId = 'local_' + Date.now();
        let isPremium = false;
        let lastScreenTime = Date.now();

        // Initialize WebApp
        function initWebApp() {
            if (!tg) {
                console.error('Telegram WebApp not available');
                return false;
            }
            
            tg.ready();
            tg.expand();
            tg.MainButton.hide();
            
            if (tg.initDataUnsafe?.user) {
                userId = tg.initDataUnsafe.user.id;
                isPremium = tg.initDataUnsafe.user.is_premium || false;
                console.log('User initialized:', tg.initDataUnsafe.user);
            }
            
            return true;
        }

        // API base URL
        const API_BASE = 'https://f50fc94ac016.ngrok-free.app';

        // Append message to chat
        function appendMessage(sender, text) {
            const chatWindow = document.getElementById('chat-window');
            const msg = document.createElement('div');
            msg.className = sender === 'user' 
                ? 'user-message bg-pink-600 p-3 rounded-lg max-w-[80%] self-end text-sm' 
                : 'bot-message bg-gray-700 p-3 rounded-lg max-w-[80%] self-start text-sm';
            msg.textContent = text;
            chatWindow.appendChild(msg);
            scrollChat();
        }

        // Show typing indicator
        function showTyping() {
            const typing = document.getElementById('typing-indicator');
            typing.style.display = 'flex';
            scrollChat();
        }

        // Hide typing indicator
        function hideTyping() {
            document.getElementById('typing-indicator').style.display = 'none';
        }

        // Scroll chat to bottom
        function scrollChat() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Send message to backend
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            appendMessage('user', message);
            input.value = '';
            showTyping();
            
            try {
                const response = await fetch(`${API_BASE}/api/pulse`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        pulse: message,
                        userId,
                        isPremium
                    })
                });
                
                const data = await response.json();
                hideTyping();
                
                if (data.error) {
                    appendMessage('bot', `–û—à–∏–±–∫–∞: ${data.error}`);
                } else {
                    appendMessage('bot', data.text);
                }
            } catch (error) {
                hideTyping();
                console.error('Error sending message:', error);
                appendMessage('bot', '–°–±–æ–π —Å–µ—Ç–∏, –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞! üòï');
            }
        }

        // Buy crystals
        async function buyCrystals() {
            try {
                const response = await fetch(`${API_BASE}/api/buy_crystals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({ userId, amount: 10 })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    appendMessage('bot', `–û—à–∏–±–∫–∞: ${data.error}`);
                } else {
                    appendMessage('bot', `+10 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤! –ë–∞–ª–∞–Ω—Å: ${data.balance} üíé`);
                }
            } catch (error) {
                console.error('Error buying crystals:', error);
                appendMessage('bot', '–°–±–æ–π —Å–µ—Ç–∏, –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞! üòï');
            }
        }

        // Request photo
        async function requestPhoto(mode) {
            try {
                const response = await fetch(`${API_BASE}/api/request_photo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({ 
                        userId, 
                        mode, 
                        cost: mode === 'ero' ? 5 : 10 
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    appendMessage('bot', data.error);
                } else if (data.image) {
                    appendMessage('bot', `–°–Ω–∏–º–æ–∫ (${mode})! üî•`);
                    const img = document.createElement('img');
                    img.src = data.image + '?' + new Date().getTime();
                    img.className = 'max-w-full mt-3 rounded-lg';
                    img.alt = `–°–Ω–∏–º–æ–∫ (${mode})`;
                    document.getElementById('chat-window').appendChild(img);
                    scrollChat();
                }
            } catch (error) {
                console.error('Error requesting photo:', error);
                appendMessage('bot', '–°–±–æ–π —Å–µ—Ç–∏, –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞! üòï');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize WebApp
            if (!initWebApp()) {
                appendMessage('bot', '–û—à–∏–±–∫–∞: –û—Ç–∫—Ä–æ–π –º–µ–Ω—è –≤ Telegram –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞!');
            }

            // Bind button events
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('crystal-button').addEventListener('click', buyCrystals);
            document.getElementById('photo-ero-button').addEventListener('click', () => requestPhoto('ero'));
            document.getElementById('photo-18-button').addEventListener('click', () => requestPhoto('18+'));
            
            // Enter key to send message
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            document.getElementById('user-input').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            
            // Focus input on load
            document.getElementById('user-input').focus();
        });
    </script>
</body>
</html>
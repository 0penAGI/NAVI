<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –ü—Ä–æ–≤–æ–¥–Ω–∏–∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @keyframes star-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        @keyframes nebula-glow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .cosmic-bg {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            background-size: 400% 400%;
            animation: nebula-glow 20s ease infinite;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: star-pulse 3s infinite alternate;
        }
        .message-bubble {
            position: relative;
            overflow: hidden;
        }
        .message-bubble::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .message-bubble:hover::after {
            opacity: 1;
        }
        .chat-window::-webkit-scrollbar {
            width: 5px;
        }
        .chat-window::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 10px;
        }
        .typing-indicator span {
            animation: blink 1.4s infinite both;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="cosmic-bg text-gray-100 font-sans min-h-screen flex justify-center items-center p-4">
    <div class="container max-w-md h-[90vh] bg-gray-900 bg-opacity-70 rounded-xl flex flex-col overflow-hidden shadow-2xl backdrop-blur-sm border border-gray-700 relative">
        <!-- –ó–≤–µ–∑–¥–Ω—ã–π —Ñ–æ–Ω -->
        <div id="stars-container" class="absolute inset-0 overflow-hidden"></div>
        
        <!-- Header -->
        <header class="bg-gray-800 p-4 border-b border-gray-700 flex items-center justify-between z-10">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center text-xl">üåå</div>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-blue-300">
                    –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –ü—Ä–æ–≤–æ–¥–Ω–∏–∫
                </h1>
            </div>
            <div id="connection-status" class="flex items-center text-xs">
                <span class="w-2 h-2 rounded-full bg-green-500 mr-1"></span>
                <span>online</span>
            </div>
        </header>

        <!-- Chat Window -->
        <div id="chat-window" class="chat-window flex-1 p-4 overflow-y-auto flex flex-col gap-3 z-10">
            <div class="bot-message message-bubble bg-gray-800 p-3 rounded-lg max-w-[85%] self-start border border-gray-700">
                –ü—Ä–∏–≤–µ—Ç, –ø—É—Ç–Ω–∏–∫! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –≤–µ—Å—Ç–∏ —Ç–µ–±—è —á–µ—Ä–µ–∑ –∑–≤—ë–∑–¥—ã –∏ —Ç–µ–Ω–∏. –ö—É–¥–∞ –Ω–∞–ø—Ä–∞–≤–∏–º –Ω–∞—à –ø—É—Ç—å —Å–µ–≥–æ–¥–Ω—è? üå†
            </div>
            <div id="typing-indicator" class="typing-indicator hidden bg-gray-800 p-2 rounded-lg max-w-[50%] self-start text-sm">
                <span>‚Ä¢</span><span>‚Ä¢</span><span>‚Ä¢</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area p-3 bg-gray-800 border-t border-gray-700 flex items-center gap-2 z-10">
            <textarea id="user-input" placeholder="–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å –∫ –≤—Å–µ–ª–µ–Ω–Ω–æ–π..." class="flex-1 p-3 bg-gray-700 text-white text-sm rounded-lg resize-none min-h-[50px] max-h-[150px] focus:outline-none focus:ring-2 focus:ring-purple-500 border border-gray-600"></textarea>
            <button id="send-button" class="send-button w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center text-white hover:from-purple-700 hover:to-blue-600 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤–µ–∑–¥–Ω–æ–≥–æ —Ñ–æ–Ω–∞
        function createStars() {
            const container = document.getElementById('stars-container');
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // –°–ª—É—á–∞–π–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–≤–µ–∑–¥—ã
                const size = Math.random() * 2;
                const posX = Math.random() * 100;
                const posY = Math.random() * 100;
                const delay = Math.random() * 5;
                const duration = 2 + Math.random() * 3;
                
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${posX}%`;
                star.style.top = `${posY}%`;
                star.style.animationDelay = `${delay}s`;
                star.style.animationDuration = `${duration}s`;
                
                container.appendChild(star);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram?.WebApp;
        const API_BASE = 'https://a6a172f98dfa.ngrok-free.app';
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);

        if (tg && tg.initDataUnsafe?.user) {
            userId = tg.initDataUnsafe.user.id;
            tg.ready();
            tg.expand();
        }

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const connectionStatus = document.getElementById('connection-status');

        // –°–æ–∑–¥–∞–µ–º –∑–≤–µ–∑–¥—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        createStars();

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function appendMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' 
                ? 'user-message message-bubble bg-gradient-to-br from-purple-700 to-blue-600 p-3 rounded-lg max-w-[85%] self-end text-white'
                : 'bot-message message-bubble bg-gray-800 p-3 rounded-lg max-w-[85%] self-start border border-gray-700';
            messageDiv.textContent = text;
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }

        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
        function showTyping() {
            typingIndicator.classList.remove('hidden');
            scrollToBottom();
        }

        // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
        function hideTyping() {
            typingIndicator.classList.add('hidden');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`, {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                return response.ok;
            } catch {
                return false;
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            appendMessage('user', message);
            userInput.value = '';
            showTyping();

            try {
                const isConnected = await checkConnection();
                if (!isConnected) {
                    throw new Error('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                }

                const response = await fetch(`${API_BASE}/api/pulse`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        pulse: message,
                        userId,
                        isPremium: tg?.initDataUnsafe?.user?.is_premium || false
                    })
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }

                const data = await response.json();
                hideTyping();
                
                if (data.error) {
                    appendMessage('bot', `üåå –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –ø–æ–º–µ—Ö–∞: ${data.error}`);
                } else {
                    appendMessage('bot', data.text);
                }
            } catch (error) {
                hideTyping();
                console.error('–û—à–∏–±–∫–∞:', error);
                
                let errorMessage = 'üåÄ –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑—å –Ω–∞—Ä—É—à–µ–Ω–∞...';
                if (error.message.includes('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è')) {
                    errorMessage = 'üåë –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ—Å–º–æ—Å—É!';
                } else if (error.message.includes('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞')) {
                    errorMessage = '‚ö° –°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.';
                }
                
                appendMessage('bot', errorMessage);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        userInput.focus();
    </script>
</body>
</html>